{"ast":null,"code":"import { isEmpty, isEqual } from 'lodash';\nimport { v1 as uuid } from 'uuid';\nimport { ConsoleLogger as Logger, JS } from '@aws-amplify/core';\nimport Cache from '@aws-amplify/cache';\nvar PERSONALIZE_CACHE = '_awsct';\nvar PERSONALIZE_CACHE_USERID = '_awsct_uid';\nvar PERSONALIZE_CACHE_SESSIONID = '_awsct_sid';\nvar DEFAULT_CACHE_PREFIX = 'peronslize';\nvar TIMER_INTERVAL = 30 * 1000;\nvar DELIMITER = '.';\nvar CACHE_EXPIRY_IN_DAYS = 7;\nvar logger = new Logger('AmazonPersonalizeProvider');\n\nvar SessionInfoManager =\n/** @class */\nfunction () {\n  function SessionInfoManager(prefixKey) {\n    if (prefixKey === void 0) {\n      prefixKey = '';\n    }\n\n    this._isBrowser = JS.browserOrNode().isBrowser;\n    this._timerKey = uuid().substr(0, 15);\n\n    this._refreshTimer();\n  }\n\n  SessionInfoManager.prototype._refreshTimer = function () {\n    if (this._timer) {\n      clearInterval(this._timer);\n    }\n\n    var that = this;\n    this._timer = setInterval(function () {\n      that._timerKey = uuid().substr(0, 15);\n    }, TIMER_INTERVAL);\n  };\n\n  SessionInfoManager.prototype.storeValue = function (key, value) {\n    var today = new Date();\n    var expire = new Date();\n    expire.setTime(today.getTime() + 3600000 * 24 * CACHE_EXPIRY_IN_DAYS);\n    Cache.setItem(this._getCachePrefix(key), value, {\n      expires: expire.getTime()\n    });\n  };\n\n  SessionInfoManager.prototype.retrieveValue = function (key) {\n    return Cache.getItem(this._getCachePrefix(key));\n  };\n\n  SessionInfoManager.prototype._getCachePrefix = function (key) {\n    if (this._isBrowser) {\n      return key + DELIMITER + window.location.host;\n    }\n\n    return DEFAULT_CACHE_PREFIX;\n  };\n\n  SessionInfoManager.prototype.getTimerKey = function () {\n    return this._timerKey;\n  };\n\n  SessionInfoManager.prototype.updateSessionInfo = function (userId, sessionInfo) {\n    var existUserId = sessionInfo.userId;\n    var existSessionId = sessionInfo.sessionId;\n\n    if (this._isRequireNewSession(userId, existUserId, existSessionId)) {\n      var newSessionId = uuid();\n      this.storeValue(PERSONALIZE_CACHE_USERID, userId);\n      this.storeValue(PERSONALIZE_CACHE_SESSIONID, newSessionId);\n      sessionInfo.sessionId = newSessionId;\n    } else if (this._isRequireUpdateSessionInfo(userId, existUserId, existSessionId)) {\n      this.storeValue(PERSONALIZE_CACHE_USERID, userId);\n    }\n\n    sessionInfo.userId = userId;\n  };\n\n  SessionInfoManager.prototype._isRequireUpdateSessionInfo = function (userId, cachedSessionUserId, cachedSessionSessionId) {\n    // anonymouse => sign in : hasSession && s_userId == null && curr_userId !=null\n    var isNoCachedSession = isEmpty(cachedSessionSessionId);\n    return !isNoCachedSession && isEmpty(cachedSessionUserId) && !isEmpty(userId);\n  };\n\n  SessionInfoManager.prototype.retrieveSessionInfo = function (trackingId) {\n    var sessionInfo = {};\n    sessionInfo.trackingId = trackingId;\n    sessionInfo.sessionId = this.retrieveValue(PERSONALIZE_CACHE_SESSIONID);\n    sessionInfo.userId = this.retrieveValue(PERSONALIZE_CACHE_USERID);\n\n    if (isEmpty(sessionInfo.sessionId)) {\n      sessionInfo.sessionId = uuid();\n      this.storeValue(PERSONALIZE_CACHE_SESSIONID, sessionInfo.sessionId);\n    }\n\n    this.storeValue(PERSONALIZE_CACHE, trackingId);\n    return sessionInfo;\n  };\n\n  SessionInfoManager.prototype._isRequireNewSession = function (userId, cachedSessionUserId, cachedSessionSessionId) {\n    // new session => 1. no cached session info 2. signOut: s_userId !=null && curr_userId ==null\n    // 3. switch account: s_userId !=null && curr_userId !=null && s_userId != curr_userId\n    var isNoCachedSession = isEmpty(cachedSessionSessionId);\n    var isSignoutCase = isEmpty(userId) && !isEmpty(cachedSessionUserId);\n    var isSwitchUserCase = !isEmpty(userId) && !isEmpty(cachedSessionUserId) && !isEqual(userId, cachedSessionUserId);\n    return isNoCachedSession || isSignoutCase || isSwitchUserCase;\n  };\n\n  return SessionInfoManager;\n}();\n\nexport { SessionInfoManager };","map":{"version":3,"mappings":"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","names":["isEmpty","isEqual","v1","uuid","ConsoleLogger","Logger","JS","Cache","PERSONALIZE_CACHE","PERSONALIZE_CACHE_USERID","PERSONALIZE_CACHE_SESSIONID","DEFAULT_CACHE_PREFIX","TIMER_INTERVAL","DELIMITER","CACHE_EXPIRY_IN_DAYS","logger","prefixKey","_isBrowser","browserOrNode","isBrowser","_timerKey","substr","_refreshTimer","SessionInfoManager","_timer","clearInterval","that","setInterval","key","value","today","Date","expire","setTime","getTime","setItem","_getCachePrefix","expires","getItem","window","location","host","userId","sessionInfo","existUserId","existSessionId","sessionId","_isRequireNewSession","newSessionId","storeValue","_isRequireUpdateSessionInfo","cachedSessionUserId","cachedSessionSessionId","isNoCachedSession","trackingId","retrieveValue","isSignoutCase","isSwitchUserCase"],"sourceRoot":"","sources":["../../../src/Providers/AmazonPersonalizeHelper/SessionInfoManager.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}